--1
--1.1
CREATE Table Mitarbeiter ( 
	MitId char(3) PRIMARY KEY,
	MiTName VARCHAR(20) NOT NULL,
	MitVorname varchar(20),
	MitGebDat Date NOT NULL,
	MitJob varchar(20) NOT NULL,
	MitStundensat smallmoney,
	MitEinsatzort varchar(20)
	)


CREATE TABLE Kunde(
KunNr Int PRIMARY KEY Not Null,
KunName varchar(20) Not Null,
KunOrt varchar(20) Not Null,
KunPLZ char(5) Not Null,
KunStrasse varchar(20) Not Null
)

CREATE TABLE Ersatzteil ( 
EtID char(5) PRIMARY KEY Not Null,
EtBezeichnung varchar(100) Not Null,
EtPreis smallmoney Not Null,
EtAnzLager Int Not Null,
EtHersteller varchar(30) Not Null
)


--1.2
INSERT INTO Mitarbeiter SELECT * FROM trommelhelden..quelleMitarbeiter
INSERT INTO Kunde SELECT * FROM trommelhelden..quelleKunde
INSERT INTO Ersatzteil SELECT * FROM trommelhelden..quelleErsatzteil


SELECT * FROM Mitarbeiter
SELECT * FROM Kunde
SELECT * FROM Ersatzteil

--1.3
SELECT * INTO Auftrag FROM trommelhelden..quelleAuftrag
SELECT * INTO Montage FROM trommelhelden..quelleMontage

--1.4
Alter TABLE Auftrag ADD PRIMARY KEY (AufNr);
Alter TABLE Auftrag ADD Foreign KEY (MitID) References Mitarbeiter(MitID);
Alter TABLE Auftrag ADD Foreign KEY (KunNr) References Kunde(KunNr); 

Alter TABLE Montage ADD PRIMARY KEY (AufNr,EtID);
Alter TABLE Montage ADD Foreign KEY (EtID) References Ersatzteil(EtID);
Alter TABLE Montage ADD Foreign KEY (AufNr) References Auftrag(AufNr); 

--2.1
--a)
Select * From Kunde WHERE KunOrt = 'Radebeul';
--c)
Select * From Ersatzteil Where EtBezeichnung Like 'S%';
--d)
Select * From Auftrag WHERE Dauer <= 3 AND Dauer >= 2 OR Anfahrt >= 80;
--e)
Select MiTName, MitJob From Mitarbeiter Where MitEinsatzort = 'Radebeul' Order By MiTName;
--f)
Select * From Auftrag Where Dauer is NULL;
--g)
Select Aufnr, (Anfahrt * 2.5) As Anfahrtskosten From Auftrag Where Dauer is not NULL;

--2.2 
--a)
Select MiTName, MitVorname, MitGebDat, (Year(CURRENT_TIMESTAMP) - YEAR(MitGebDat)) as 'Alter' from Mitarbeiter
--b)
Select (AVG(Day(ErlDat)-Day(AufDat))) as Auftragsfrist From Auftrag Where Month(ErlDat) Like month(getdate());
--c)
Select COALESCE(Dauer, 0) From Auftrag;

--2.3
--a)
select Count(Distinct KunNr) From Kunde;
--b)
select Count(Distinct KunNr) As KunImOrt, KunOrt From Kunde Group by KunOrt;
--c)
Select Avg(Dauer), MItID from Auftrag Where MitID is not Null Group By MitID;
--d)
Select Avg(Dauer) as AVGDauer ,MIN(Dauer) as MINDauer,Max(Dauer) As MaxDauer, MItID from Auftrag Where MitID is not Null Group By MitID;
--e)
Select Avg(Dauer), MItID, ErlDat, (Count(AufNr)) from Auftrag Where MitID is not Null and Dauer is not Null Group By MitID, ErlDat;
--f)
Select Min(ErlDat) from Auftrag Where ErlDat is not Null And Dauer is Null;

--2.4
--a
Select MitJob, avg(datediff(Year, MitGebDat, getdate())) From Mitarbeiter Group By MitJob;
--b
SELECT MitID, avg(Dauer), (datepart(WEEKDAY,ErlDat)) As Wochentag
From Auftrag 
Where MitID is not NULL
Group by MitId, (datepart(WEEKDAY,ErlDat));

--)2.5
--a)
Select AufNr, EtBezeichnung, Anzahl, EtPreis, Anzahl*EtPreis as Gesamtpreis
From Montage m JOIN Ersatzteil e on m.EtID = e.EtID 
Order By AufNr;
--b)
Select AufNr, Dauer* MitStundensat as Lohnkosten from Auftrag a Join Mitarbeiter M on A.MitID = m.MitId WHERE Dauer is not NULL;


--c)
select KunName, KunOrt, Anfahrt from Kunde K Join  Auftrag A on K.KunNr = A.KunNr where Anfahrt > 50;

--d)
select KunNr from Auftrag A Join Montage M on A.AufNr = M.AufNr where EtID = 'H0230' And datediff(month,getdate(),ErlDat) <= 02;

--e)
select a.Aufnr,
	SUM(m.Anzahl*e.EtPreis) as Materialkosten,
	AVG(Dauer*i.MitStundensat) as Lohnkosten,
	AVG(a.Anfahrt)*0.2 as Fahrtkosten
from Auftrag a Join Montage m on m.AufNr=a.Aufnr Join Mitarbeiter i on i.MitID=a.MitID Join Ersatzteil e on e.EtID=m.EtID Group by a.Aufnr

--f)
select a.Aufnr, a.AufDat, m.Mitname from Auftrag a left Join Mitarbeiter m on a.MitID=m.MitID where MONTH(a.AufDat) = MONTH(GETDATE());

--g)
select e.EtID, Sum(m.Anzahl)
from Ersatzteil e Join Montage m on m.EtID = e.EtID Join ( select* from Auftrag where Month(ErlDat) = Month(GETDATE()) -1) a on a.Aufnr = m.AufNr
Group by e.EtID;
